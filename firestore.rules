rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Note: With application-level authentication, we allow all reads/writes
    // Authentication and authorization are handled in the application layer
    // For production, consider using Firebase Admin SDK or custom tokens
    
    // Helper functions (kept for compatibility, but rules are permissive)
    function isAuthenticated() {
      return true; // Allow all - auth checked in app
    }
    
    // Authorization is handled in the application layer
    // These functions always return true - checks happen in app code
    function isAdmin() {
      return true; // Checked in app
    }
    
    function isSalesManager() {
      return true; // Checked in app
    }
    
    function isSalesRep() {
      return true; // Checked in app
    }
    
    function isOwner(data) {
      return true; // Checked in app
    }
    
    function isCreator(data) {
      return true; // Checked in app
    }
    
    function isAssigned(data) {
      return true; // Checked in app
    }
    
    // Validation functions
    function isValidOpportunity() {
      let data = request.resource.data;
      return data.size() <= 15 &&
        data.name is string && 
        data.name.size() > 0 && 
        data.name.size() <= 200 &&
        (data.accountId == null || data.accountId is string) &&
        (data.amount == null || (data.amount is number && data.amount >= 0)) &&
        data.stage in ['New', 'Qualified', 'Proposal', 'Negotiation', 'Closed Won', 'Closed Lost'] &&
        (data.probability == null || (data.probability is number && data.probability >= 0 && data.probability <= 100)) &&
        (data.expectedCloseDate == null || data.expectedCloseDate is timestamp) &&
        (data.description == null || (data.description is string && data.description.size() <= 5000)) &&
        data.owner is string &&
        data.owner.size() > 0 &&
        data.createdAt is timestamp &&
        data.updatedAt is timestamp;
    }
    
    function isValidAccount() {
      let data = request.resource.data;
      return data.size() <= 20 &&
        data.name is string && 
        data.name.size() > 0 && 
        data.name.size() <= 200 &&
        (data.website == null || (data.website is string && data.website.size() <= 500)) &&
        (data.industry == null || (data.industry is string && data.industry.size() <= 100)) &&
        (data.phone == null || (data.phone is string && data.phone.size() <= 20)) &&
        (data.email == null || (data.email is string && data.email.matches('^[^@]+@[^@]+\\.[^@]+$'))) &&
        data.status in ['active', 'inactive', 'prospect'] &&
        (data.description == null || (data.description is string && data.description.size() <= 5000)) &&
        (data.assignedTo == null || data.assignedTo is string) &&
        data.createdAt is timestamp &&
        data.updatedAt is timestamp &&
        (data.lastContact == null || data.lastContact is timestamp);
    }
    
    function isValidUser() {
      let data = request.resource.data;
      return data.size() <= 15 &&
        data.email is string && 
        data.email.size() > 0 &&
        data.email.matches('^[^@]+@[^@]+\\.[^@]+$') &&
        (data.displayName == null || (data.displayName is string && data.displayName.size() <= 200)) &&
        (data.firstName == null || (data.firstName is string && data.firstName.size() <= 100)) &&
        (data.lastName == null || (data.lastName is string && data.lastName.size() <= 100)) &&
        (data.phone == null || (data.phone is string && data.phone.size() <= 20)) &&
        (data.photoURL == null || (data.photoURL is string && data.photoURL.size() <= 500)) &&
        data.role in ['admin', 'sales_manager', 'sales_rep', 'user'] &&
        data.isActive is bool &&
        (data.department == null || (data.department is string && data.department.size() <= 100)) &&
        (data.title == null || (data.title is string && data.title.size() <= 100)) &&
        data.createdAt is timestamp &&
        data.updatedAt is timestamp &&
        (data.lastLogin == null || data.lastLogin is timestamp);
    }
    
    function isValidContact() {
      let data = request.resource.data;
      return data.size() <= 20 &&
        data.firstName is string && 
        data.firstName.size() > 0 && 
        data.firstName.size() <= 100 &&
        data.lastName is string && 
        data.lastName.size() > 0 && 
        data.lastName.size() <= 100 &&
        data.accountId is string &&
        data.accountId.size() > 0 &&
        (data.email == null || (data.email is string && data.email.matches('^[^@]+@[^@]+\\.[^@]+$'))) &&
        (data.phone == null || (data.phone is string && data.phone.size() <= 20)) &&
        (data.mobile == null || (data.mobile is string && data.mobile.size() <= 20)) &&
        (data.title == null || (data.title is string && data.title.size() <= 100)) &&
        (data.department == null || (data.department is string && data.department.size() <= 100)) &&
        (data.mailingAddress == null || data.mailingAddress is map) &&
        (data.isPrimary == null || data.isPrimary is bool) &&
        (data.notes == null || (data.notes is string && data.notes.size() <= 2000)) &&
        data.createdBy is string &&
        data.createdBy.size() > 0 &&
        data.createdAt is timestamp &&
        data.updatedAt is timestamp;
    }
    
    function isValidNote() {
      let data = request.resource.data;
      return data.size() <= 10 &&
        data.content is string && 
        data.content.size() > 0 && 
        data.content.size() <= 10000 &&
        (data.accountId == null || data.accountId is string) &&
        (data.contactId == null || data.contactId is string) &&
        (data.opportunityId == null || data.opportunityId is string) &&
        (data.isPrivate == null || data.isPrivate is bool) &&
        data.createdBy is string &&
        data.createdAt is timestamp &&
        data.updatedAt is timestamp;
    }
    
    function isValidTask() {
      let data = request.resource.data;
      return data.size() <= 15 &&
        data.title is string && 
        data.title.size() > 0 && 
        data.title.size() <= 200 &&
        (data.description == null || (data.description is string && data.description.size() <= 5000)) &&
        data.status in ['not_started', 'in_progress', 'completed', 'cancelled'] &&
        data.priority in ['low', 'medium', 'high'] &&
        (data.dueDate == null || data.dueDate is timestamp) &&
        (data.completedAt == null || data.completedAt is timestamp) &&
        (data.accountId == null || data.accountId is string) &&
        (data.contactId == null || data.contactId is string) &&
        (data.opportunityId == null || data.opportunityId is string) &&
        (data.assignedTo == null || data.assignedTo is string) &&
        data.createdBy is string &&
        data.createdAt is timestamp &&
        data.updatedAt is timestamp;
    }

    // Roles collection (for role management)
    match /roles/{userId} {
      allow read: if isAuthenticated() && 
        (request.auth.uid == userId || isAdmin());
      allow write: if isAdmin();
    }
    
    // Opportunities collection (formerly Leads)
    // Note: Application-level authentication - security handled in app code
    match /opportunities/{opportunityId} {
      allow read: if true; // Application validates access
      allow create: if 
        request.resource.data.name is string &&
        request.resource.data.stage is string &&
        request.resource.data.owner is string &&
        request.resource.data.createdAt is timestamp &&
        request.resource.data.updatedAt is timestamp;
      allow update: if 
        request.resource.data.name is string &&
        request.resource.data.stage is string &&
        request.resource.data.owner is string &&
        request.resource.data.createdAt == resource.data.createdAt;
      allow delete: if true; // Application validates permissions
    }
    
    // Accounts collection (formerly Customers)
    // Note: Application-level authentication - security handled in app code
    match /accounts/{accountId} {
      allow read: if true; // Application validates access
      allow create: if 
        request.resource.data.name is string &&
        request.resource.data.status is string &&
        request.resource.data.createdAt is timestamp &&
        request.resource.data.updatedAt is timestamp;
      allow update: if 
        request.resource.data.name is string &&
        request.resource.data.status is string &&
        request.resource.data.createdAt == resource.data.createdAt;
      allow delete: if true; // Application validates permissions
    }
    
    // Users collection
    // Note: Application-level authentication means request.auth is always null
    // So we need to allow unauthenticated access for login, but restrict what can be done
    match /users/{userId} {
      // Allow list queries for login (email lookup) and authenticated users
      allow list: if true;
      // Allow get for login and authenticated access
      // Password verification happens in application code
      allow get: if true;
      // Allow create only by admins (but since we use app-level auth, this is handled in app)
      allow create: if true; // Application validates admin role
      // Allow updates:
      // - Application code handles authorization (admin checks, etc.)
      // - Only ensure createdAt doesn't change (immutable field)
      allow update: if 
        // Ensure createdAt doesn't change (immutable field)
        request.resource.data.createdAt == resource.data.createdAt;
      // Allow delete - validated in application code
      allow delete: if true; // Application validates admin role
    }
    
    // Contacts collection
    // Note: Application-level authentication - security handled in app code
    match /contacts/{contactId} {
      allow read: if true; // Application validates access
      allow create: if true; // Application validates all data and permissions
      allow update: if true; // Application validates all data and permissions
      allow delete: if true; // Application validates permissions
    }
    
    // Notes collection
    // Note: Application-level authentication - security handled in app code
    match /notes/{noteId} {
      allow list: if true; // Application filters private notes
      allow get: if true; // Application validates access to private notes
      allow create: if 
        request.resource.data.content is string &&
        request.resource.data.createdBy is string &&
        request.resource.data.createdAt is timestamp &&
        request.resource.data.updatedAt is timestamp;
      allow update: if 
        request.resource.data.content is string &&
        request.resource.data.createdAt == resource.data.createdAt &&
        request.resource.data.createdBy == resource.data.createdBy;
      allow delete: if true; // Application validates permissions
    }
    
    // Tasks collection
    // Note: Application-level authentication - security handled in app code
    match /tasks/{taskId} {
      allow read: if true; // Application validates access
      allow create: if 
        request.resource.data.title is string &&
        request.resource.data.status is string &&
        request.resource.data.priority is string &&
        request.resource.data.createdBy is string &&
        request.resource.data.createdAt is timestamp &&
        request.resource.data.updatedAt is timestamp;
      allow update: if 
        request.resource.data.title is string &&
        request.resource.data.status is string &&
        request.resource.data.priority is string &&
        request.resource.data.createdAt == resource.data.createdAt &&
        request.resource.data.createdBy == resource.data.createdBy;
      allow delete: if true; // Application validates permissions
    }
    
    // Inbound Emails collection
    // Note: Application-level authentication - security handled in app code
    match /inboundEmails/{emailId} {
      allow read: if true; // Application validates access (admin only in app)
      allow list: if true; // Application validates access (admin only in app)
      allow create: if 
        request.resource.data.messageId is string &&
        request.resource.data.from is map &&
        request.resource.data.to is list &&
        request.resource.data.subject is string &&
        request.resource.data.body is map &&
        request.resource.data.receivedAt is timestamp &&
        request.resource.data.read is bool &&
        request.resource.data.processed is bool &&
        request.resource.data.createdAt is timestamp &&
        request.resource.data.updatedAt is timestamp;
      allow update: if 
        request.resource.data.messageId == resource.data.messageId &&
        request.resource.data.receivedAt == resource.data.receivedAt &&
        request.resource.data.createdAt == resource.data.createdAt;
      allow delete: if true; // Application validates permissions (admin only)
    }
    
    // Legacy collections (for backward compatibility during migration)
    match /leads/{leadId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    
    match /customers/{customerId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
  }
}
