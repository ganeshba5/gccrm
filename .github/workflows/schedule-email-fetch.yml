name: Schedule Email Fetch

on:
  schedule:
    # Run once per day at 7:00 AM UTC
    - cron: '0 7 * * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  fetch_emails:
    runs-on: ubuntu-latest
    steps:
      - name: Call Firebase Cloud Function
        env:
          FUNCTION_URL: ${{ secrets.FIREBASE_FUNCTION_URL || 'https://us-central1-gccrmapp.cloudfunctions.net/fetchEmails' }}
          FUNCTION_SECRET: ${{ secrets.FIREBASE_FUNCTION_SECRET }}
        run: |
          echo "ðŸ§ª Calling Firebase Cloud Function: fetchEmails"
          echo "ðŸ“ Function URL: $FUNCTION_URL"
          
          # Prepare headers
          HEADERS=(-H "Content-Type: application/json")
          if [ -n "$FUNCTION_SECRET" ]; then
            HEADERS+=(-H "Authorization: Bearer $FUNCTION_SECRET")
            echo "ðŸ” Using authentication token"
          fi
          
          # Call the function
          RESPONSE=$(curl -s -w "\n%{http_code}" "${HEADERS[@]}" "$FUNCTION_URL" || echo -e "\n000")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo ""
          echo "ðŸ“¥ Response received"
          echo "Status: $HTTP_CODE"
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Email fetch completed successfully"
            echo "$BODY" | jq '.' 2>/dev/null || echo "$BODY"
            exit 0
          else
            echo "âŒ Email fetch failed"
            echo "Response body:"
            echo "$BODY" | jq '.' 2>/dev/null || echo "$BODY"
            exit 1
          fi
